---
title: "Patrones puntuales"
author: 
  - "Juan José Galeano Arenas"
  - "Juan Sebastián Mendoza Páez"
  - "Germán Alonso Patiño Hurtado"
date: '2022-06-05'
output:
  html_document:
    code_folding: hide
    theme: readable
---

```{r message=FALSE, warning=FALSE}
library(RSocrata)
library(tidyverse)
library(lubridate)
library(tidygeocoder)
library(rgeoboundaries)
library(sf)
library(tmap)
library(spatstat)
source("Funciones_propias_ppp.R", encoding = "UTF-8")
```

# Contextualización

La accidentalidad es uno de los problemas más comunes en el planeta provocando perdidas que pueden ir desde materiales hasta la vida misma, por lo que es de particular interés tratar de comprender como se comporta este fenómeno para evitar ser victimas de él. 

La problemática en cuestión tiene la complicación de ser algo de naturaleza aleatoria, sin embargo esto no quiere decir que no exista alguna forma de controlarla pues la experiencia ha mostrado que las diferentes ciudades tienen lugares con mayor concentración de accidentes que otras ubicaciones dentro de la misma ciudad.

Debido a que se está trabajando la ocurrencia de accidentes en una ciudad de interés, la distribución Poisson y los procesos puntuales Poisson resultan ser una herramienta adecuada para tratar de explicar el fenómeno.

El estudio de accidentalidad se hará en los años 2019, 2020 y 2021 con el propósito de ver como se comporta la accidentalidad prepandemia, pandemia y postpandemia.

# Obtención de la base de datos

Una vez presentado el fenómeno que se trabajará, se selecciona la ciudad de Barranquilla para realizar el estudio. 

Los datos se extrajeron de la página web GOV.CO la cual tiene diferentes bases da datos de Colombia abiertas al público. (<a href="https://www.datos.gov.co/Transporte/Accidentalidad-en-Barranquilla/yb9r-2dsi/data"> Accidentalidad en Barranquilla</a>). La base de datos contiene una gran cantidad de variables, sin embargo solo se escogen aquellas de interés para el patrón puntual. La estructura de los datos es presentada a continuación:

```{r}
accidentes <- read.socrata("https://www.datos.gov.co/resource/yb9r-2dsi.json") %>%
    mutate(fecha = ymd(fecha_accidente)) %>%
    select(12, 6:8) %>%
    filter(year(fecha) > 2018 & year(fecha) < 2022)
knitr::kable(head(accidentes, 10),
             col.names = c("Fecha", "Gravedad del accidentes",
                           "Clase de accidentes", "Sitio accidente"))
```

# Geocodificación de las direcciones

Se hace necesario realizarle unos ajustes a la base de datos considerada puesto que está no incluye las ubicaciones exactas de los accidentes ya sea en longitud - latitud o proyección UTM, para dicho propósito se usa la función `geo()` del paquete `tidygeocoder` para convertir las direcciones de los accidentes en coordenadas de longitud - latitud. 

```{r eval=FALSE, include=TRUE}
direcciones <- paste(accidentes$sitio_exacto_accidente, ", Barranquilla, Colombia", sep = "")
localizaciones <- geo(address = direcciones, method = "arcgis")
write.csv(x = localizaciones, file = "accidentes.csv", row.names = F)
```

Luego de realizar obtener las coordenadas en longitud - latitud, se usan múltiples funciones del paquete `sf` para obtener las respectivas ubicaciones en formato UTM obteniendose lo siguiente:

```{r message=FALSE, warning=FALSE}
bqlla <- geoboundaries(country = "COLOMBIA", adm_lvl = 2) %>%
    filter(shapeName == "DISTRITO ESPECIAL, INDUSTRIAL Y PORTUARIO DE BARR*")%>%
    st_transform(crs = 3857)

coordenadas <- read.csv("accidentes.csv")
coordenadas <- cbind(accidentes, coordenadas[, 2:3]) %>%
                st_as_sf(coords = c('long', 'lat')) %>%
                st_set_crs(value = 4326) %>%
                st_transform(crs = 3857) %>%
                st_intersection(bqlla)

accidentes <- list()
for(i in 2019:2021){
  accidentes[[as.character(i)]] <- filter(coordenadas, year(fecha) == i & month(fecha) > 3)
}
knitr::kable(head(accidentes[["2019"]][, c(1:4, 10)], 10))
```

# Gráfico de las localizaciones {.tabset .tabset-fade .tabset-pills}

## Accidentes 2019

```{r message=FALSE, warning=FALSE, fig.align='center'}
tmap_mode('view')

tm_shape(bqlla)+
  tm_polygons(alpha = 0.3, border.alpha = 0.7)+
  tm_shape(shp = accidentes[['2019']])+
  tm_dots(size = 0.01)
```

## Accidentes 2020

```{r message=FALSE, warning=FALSE, fig.align='center'}
tmap_mode('view')

tm_shape(bqlla)+
  tm_polygons(alpha = 0.3, border.alpha = 0.7)+
  tm_shape(shp = accidentes[['2020']])+
  tm_dots(size = 0.01)
```

## Accidentes 2021

```{r message=FALSE, warning=FALSE, fig.align='center'}
tmap_mode('view')

tm_shape(bqlla)+
  tm_polygons(alpha = 0.3, border.alpha = 0.7)+
  tm_shape(shp = accidentes[['2021']])+
  tm_dots(size = 0.01)
```

# Pruebas de homogeneidad en la intensidad

Uno de los parámetros críticos al momento de modelar un patrón puntual es la intensidad la cual puede ser constante (homogénea) o variable (inhomogénea), por lo tanto es importante iniciar el análisis con una prueba de homogeneidad de la intensidad.

```{r message=FALSE, warning=FALSE, fig.height=8}
# Guardando datos por anio
datos_2019 <- ppp(x = st_coordinates(accidentes[[1]])[, 1],
             y = st_coordinates(accidentes[[1]])[, 2],
             window = as.owin(W = bqlla))

datos_2020 <- ppp(x = st_coordinates(accidentes[[2]])[, 1],
             y = st_coordinates(accidentes[[2]])[, 2],
             window = as.owin(W = bqlla))

datos_2021 <- ppp(x = st_coordinates(accidentes[[3]])[, 1],
             y = st_coordinates(accidentes[[3]])[, 2],
             window = as.owin(W = bqlla))
```

## Argumento gráfico {.tabset .tabset-fade .tabset-pills}

Para iniciar, se divide el mapa de Barranquilla en 25 cuadrantes, si el patrón fuera homogéneo se esperaría que el número de accidentes en cada uno de las subsecciones de la ciudad contenga aproximadamente la misma cantidad de accidentes.

### Conteos 2019

```{r}
qc_2019 <- quadratcount(datos_2019, nx = 5, ny = 5)
plot(qc_2019, main = "Accidentes en 2019")
```

### Conteos 2020

```{r}
qc_2020 <- quadratcount(datos_2020, nx = 5, ny = 5)
plot(qc_2020, main = "Accidentes en 2020")
```

### Conteos 2021

```{r}
qc_2021 <- quadratcount(datos_2021, nx = 5, ny = 5)
plot(qc_2021, main = "Accidentes en 2021")
```

# Observaciones  {.unlisted .unnumbered}

En todos los años se aprecia que hay una gran discrepancia entre el número de accidentes por sectores. Claramente al este de la ciudad el número de accidentes es mayor respecto al oeste lo cual es una fuerte señal de que el patrón puntual en cuestión es de naturaleza inhomogénea.

## Pruebas $\chi^2$ {.tabset .tabset-fade .tabset-pills}

Adicional a los conteos del número de accidentes en cada uno de los sectores definidos previamente, se usa la prubea $\chi^2$ para contrastar:

$$
\begin{cases}
H_0: \text{La intensidad es constante} \\
H_1: \text{La intensidad no es constante}
\end{cases}
$$
A continuación se presentan los resultados obtenidos

### Accidentes en 2019

```{r warning = F}
quadrat.test(qc_2019)
```


### Accidentes en 2020

```{r warning = F}
quadrat.test(qc_2020)
```

### Accidentes en 2021

```{r warning = F}
quadrat.test(qc_2021)
```

# Conclusiones {.unlisted .unnumbered}

Puesto que en todos los casos se tienen valores - p demasiado pequeños (orden de $10^{-16}$) se rechaza la hipótesis de homogeneidad de intensidad en todos los casos, por lo tanto se hace necesario estimarla con algún método.

# Mapas de probabilidad {.tabset .tabset-fade .tabset-pills}

## Año 2019

```{r}
graph_ppp(datos_2019, 350, "Año 2019")
```

## Año 2020

```{r}
graph_ppp(datos_2020, 350, "Año 2020")
```

## Año 2021

```{r}
graph_ppp(datos_2021, 350, "Año 2021")
```